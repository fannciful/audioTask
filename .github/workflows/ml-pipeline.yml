# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚        ML PIPELINE CI/CD CONFIGURATION                      â”‚
# â”‚   Automated Training Â· Validation Â· Benchmark Â· Deployment   â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

name: "ðŸ¤– ML Pipeline: Train â†’ Validate â†’ Deploy"

on:
  
  # â”€â”€ Trigger 1: Pull Request Events â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  pull_request:
    branches: ["main", "master"]
    types: ["opened", "synchronize", "reopened"]
  
  # â”€â”€ Trigger 2: Push to Main Branches â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  push:
    branches: ["main", "master"]
    paths-ignore:
      - "README.md"
      - "docs/**"
      - "*.md"
  
  # â”€â”€ Trigger 3: Manual Execution via UI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  workflow_dispatch:
    inputs:
      training_epochs:
        description: "Number of training epochs"
        required: true
        default: "2"
        type: string
      use_minimal_data:
        description: "Use minimal dataset (for quick testing)"
        required: false
        default: true
        type: boolean
      push_to_registry:
        description: "Push image to GitHub Container Registry"
        required: false
        default: false
        type: boolean

# â”€â”€ Global Environment Variables â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
env:
  REGISTRY: "ghcr.io"
  IMAGE_NAME: "${{ github.repository }}"
  MODEL_ARTIFACT: "model-artifacts-${{ github.run_id }}"

# â”€â”€ Pipeline Jobs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
jobs:
  
  # â”€â”€ JOB 1: Model Training & Container Build â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  train-and-build:
    name: "ðŸ—ï¸ Train & Build"
    runs-on: "ubuntu-latest"
    timeout-minutes: 30
    outputs:
      model-version: "${{ steps.version.outputs.model-version }}"
      training-status: "${{ steps.train.outputs.training-status }}"
      accuracy: "${{ steps.train.outputs.accuracy }}"
    
    steps:
      # Step 1.1: Repository checkout
      - name: "ðŸ“¥ Checkout code"
        uses: actions/checkout@v4
      
      # Step 1.2: System preparation
      - name: "ðŸ§¹ Free disk space"
        run: |
          sudo apt-get clean
          docker system prune -f || true
      
      # Step 1.3: Docker setup
      - name: "ðŸ³ Configure Docker Buildx"
        uses: docker/setup-buildx-action@v3
      
      # Step 1.4: Version generation
      - name: "ðŸ·ï¸ Generate model version"
        id: version
        run: |
          TIMESTAMP=$(date +%Y%m%d%H%M%S)
          VERSION="model-${TIMESTAMP}-${GITHUB_SHA:0:8}"
          echo "model-version=${VERSION}" >> $GITHUB_OUTPUT
      
      # Step 1.5: Build training image
      - name: "ðŸ”¨ Build training image"
        run: |
          docker build -f docker/Dockerfile.train -t train-image:latest .
      
      # Step 1.6: Execute training
      - name: "ðŸš€ Train model"
        id: train
        run: |
          mkdir -p artifacts
          docker run --rm \
            -v $(pwd)/artifacts:/app/artifacts \
            -v $(pwd)/data:/app/data \
            -e EPOCHS="${{ github.event.inputs.training_epochs || '2' }}" \
            -e SAMPLES_PER_CLASS="${{ github.event.inputs.use_minimal_data && '10' || '50' }}" \
            train-image:latest
          
          if [ -f "artifacts/model.pth" ]; then
            echo "training-status=success" >> $GITHUB_OUTPUT
            ACCURACY=$(grep "Final Accuracy" artifacts/training.log | grep -o '[0-9]*\.[0-9]*' | head -1 || echo "0")
            echo "accuracy=$ACCURACY" >> $GITHUB_OUTPUT
          else
            echo "training-status=failed" >> $GITHUB_OUTPUT
            exit 1
          fi
      
      # Step 1.7: Build inference image
      - name: "ðŸ”¨ Build inference image"
        run: |
          docker build -f docker/Dockerfile.inference -t inference-image:latest .
      
      # Step 1.8: Upload artifacts
      - name: "ðŸ“¤ Upload trained model"
        uses: actions/upload-artifact@v4
        with:
          name: "${{ env.MODEL_ARTIFACT }}"
          path: artifacts/
          retention-days: 30
  
  # â”€â”€ JOB 2: Model Validation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  model-validation:
    name: "ðŸ§ª Validate Model"
    runs-on: "ubuntu-latest"
    needs: train-and-build
    if: needs.train-and-build.outputs.training-status == 'success'
    
    steps:
      - name: "ðŸ“¥ Checkout code"
        uses: actions/checkout@v4
      
      - name: "ðŸ“¥ Download model artifacts"
        uses: actions/download-artifact@v4
        with:
          name: "${{ env.MODEL_ARTIFACT }}"
          path: artifacts/
      
      - name: "ðŸ Setup Python environment"
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"
      
      - name: "ðŸ“¦ Install dependencies"
        run: pip install -r requirements.txt
      
      - name: "ðŸ” Run validation tests"
        run: |
          python -c "
          import torch
          import json
          from train import AudioClassifier
          
          model = AudioClassifier(num_classes=4)
          model.load_state_dict(torch.load('artifacts/model.pth', map_location='cpu'))
          model.eval()
          
          # Validation logic here
          print('âœ… Validation completed')
          "
      
      - name: "ðŸ“¤ Upload validation results"
        uses: actions/upload-artifact@v4
        with:
          name: "validation-results-${{ github.run_id }}"
          path: artifacts/
          retention-days: 30
  
  # â”€â”€ JOB 3: Performance Benchmark â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  benchmark-and-test:
    name: "âš¡ Performance Benchmark"
    runs-on: "ubuntu-latest"
    needs: [train-and-build, model-validation]
    if: needs.train-and-build.outputs.training-status == 'success'
    
    steps:
      - name: "ðŸ“¥ Checkout code"
        uses: actions/checkout@v4
      
      - name: "ðŸ“¥ Download model artifacts"
        uses: actions/download-artifact@v4
        with:
          name: "${{ env.MODEL_ARTIFACT }}"
          path: artifacts/
      
      - name: "ðŸ³ Build inference image"
        run: docker build -f docker/Dockerfile.inference -t inference-image:latest .
      
      - name: "â±ï¸ Run latency benchmark"
        run: |
          docker run -d --name bench-server -p 5000:5000 inference-image:latest
          sleep 15
          # Benchmark code here
          docker stop bench-server && docker rm bench-server
      
      - name: "ðŸ“¤ Upload benchmark results"
        uses: actions/upload-artifact@v4
        with:
          name: "benchmark-results-${{ github.run_id }}"
          path: benchmark_metrics.json
          retention-days: 30
  
  # â”€â”€ JOB 4: Container Registry Deployment â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  deploy-to-registry:
    name: "ðŸš€ Deploy to Registry"
    runs-on: "ubuntu-latest"
    needs: [train-and-build, model-validation, benchmark-and-test]
    if: |
      (github.event_name == 'push' && github.ref == 'refs/heads/main') ||
      (github.event_name == 'push' && github.ref == 'refs/heads/master') ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.push_to_registry == 'true')
    
    permissions:
      contents: read
      packages: write
    
    steps:
      - name: "ðŸ“¥ Checkout code"
        uses: actions/checkout@v4
      
      - name: "ðŸ“¥ Download model artifacts"
        uses: actions/download-artifact@v4
        with:
          name: "${{ env.MODEL_ARTIFACT }}"
          path: artifacts/
      
      - name: "ðŸ”  Convert to lowercase"
        id: repo-name
        run: |
          LOWER=$(echo "${{ github.repository }}" | tr '[:upper:]' '[:lower:]')
          echo "lowercase-repo=$LOWER" >> $GITHUB_OUTPUT
      
      - name: "ðŸ” Login to GHCR"
        uses: docker/login-action@v3
        with:
          registry: "${{ env.REGISTRY }}"
          username: "${{ github.actor }}"
          password: "${{ secrets.GITHUB_TOKEN }}"
      
      - name: "ðŸ“¦ Build & Push image"
        run: |
          IMAGE_NAME="${{ steps.repo-name.outputs.lowercase-repo }}"
          VERSION="${{ needs.train-and-build.outputs.model-version }}"
          
          docker build -f docker/Dockerfile.inference \
            -t ${{ env.REGISTRY }}/$IMAGE_NAME:latest \
            -t ${{ env.REGISTRY }}/$IMAGE_NAME:$VERSION .
          
          docker push ${{ env.REGISTRY }}/$IMAGE_NAME:latest
          docker push ${{ env.REGISTRY }}/$IMAGE_NAME:$VERSION
  
  # â”€â”€ JOB 5: Pipeline Report Generation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  generate-report:
    name: "ðŸ“Š Generate Report"
    runs-on: "ubuntu-latest"
    needs: [train-and-build, model-validation, benchmark-and-test, deploy-to-registry]
    if: always()
    
    steps:
      - name: "ðŸ“¥ Checkout code"
        uses: actions/checkout@v4
      
      - name: "ðŸ“ Create markdown report"
        run: |
          cat > report.md << 'EOF'
          # Pipeline Execution Summary
          - Run ID: ${{ github.run_id }}
          - Status: ${{ job.status }}
          - Model Version: ${{ needs.train-and-build.outputs.model-version || 'N/A' }}
          EOF
      
      - name: "ðŸ“¤ Upload report"
        uses: actions/upload-artifact@v4
        with:
          name: "pipeline-report-${{ github.run_id }}"
          path: report.md
          retention-days: 90
  
  # â”€â”€ JOB 6: Status Check for PRs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  status-check:
    name: "âœ… Status Check"
    runs-on: "ubuntu-latest"
    needs: [train-and-build, model-validation, benchmark-and-test]
    if: |
      (github.event_name == 'pull_request') ||
      (github.event_name == 'workflow_dispatch')
    
    steps:
      - name: "ðŸ” Verify pipeline results"
        run: |
          if [ "${{ needs.train-and-build.result }}" = "success" ] && \
             [ "${{ needs.model-validation.result }}" = "success" ] && \
             [ "${{ needs.benchmark-and-test.result }}" = "success" ]; then
            echo "âœ… All checks passed"
            exit 0
          else
            echo "âŒ Pipeline failed"
            exit 1
          fi

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
#  END OF PIPELINE CONFIGURATION
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€